---
title: "Analyzing Relational Contracts with R"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, dev="svg", error=TRUE, warning=FALSE)
library(dplyr)
library(RelationalContracts)
library(dyngame)
library(repgame)

```

```{r include=FALSE, eval=FALSE}

rmarkdown::render("D:/libraries/RelationalHoldup/RelationalContracts/inst/guide/RelationalContracts.Rmd")
```

# Overview

This vignette illustrates how the R package `RelationalContracting` can be used for game theoretic analysis of relationships that are modelled by infinite horizon games. I also want to give a short introduction to the general idea and motivation for relational contracts,  assuming that the reader already had some exposure to game theory.

Furthermore, I want to motivate the idea of repeated negotiation equilibria introduced in my recent paper with Susanne Goldluecke that views relational contracts as informal agreements that are repeatedly newly negotiated during the relationship. This leads to a different equilibrium selection than the traditional selection of Pareto-optimal subgame perfect equilibria. In particular, I want to motivate the concept by the `Vulnerability Paradoxon` and related rather implausible predictions by Pareto-optimal subgame perfect equilibria.

# A Principal-Agent Relationship

One classic application of relational contracting are principal-agent relationships, in which an agent repeatedly provides a service for a principal. Think of the agent being a supplier or employee of the principal.
While the principal would like to ensure approbriate effort and careful service provision by the agent, it is often not possible to verify and enforce the actually chosen effort level by formal contracts and legal means.

The key idea of relational contracting in this context is that repeated interactions allow informal enforcement of appropriate effort level. For example, parties could threat to terminate the relationship if effort is too low. Also the principal could promise to pay a bonus for good effort. She can be incentivized to indeed carry out this promise by the reward of high effort also in future periods.

Economists use game-theoretic models to better understand the trade-offs arising in relational contracting. While to a large extend research is driven simply by theoretical curiosity, ideally the derived insights can help to improve the design of institutions and agreements to foster cooperative outcomes in the real world.

## A Simple Model

We start with a simple example of an infinitely repeated principal agent game. An agent (player 2) works for a principal (player 1) and can choose every period some work effort $e$ between 0 and 1. The principal's stage game payoff is equal to the agent's effort of $$\pi_1 = e.$$ The agent incurs quadratic effort cost and has payoffs $$\pi_2 = - \frac 1 2 e^2.$$

At the beginning and end of each period, both parties can voluntary transfer money to each other. We follow the common assumption in relational contracting models and assume that both parties are risk-neutral and thus simply add the net transfers to their stage game payoffs.

For example, assume the principal transfers an amount $p_1$ to the agent and the agent transfers nothing. The transfer could be a bonus payment for positive effort by the agent in the previous period. If the agent chooses effort $e$  in the current period, the principals' total payoffs in the current period are then $e - p_1$ and the agent's $- \frac 1 2 e^2 + p_1$

We assume that principal and agent interact for infinitely many periods and discount future payoffs with a discount factor $\delta$ between 0 and 1.

## Solving in R

We can use the R package `RelationalContracts` to find the set of all subgame perfect equilibrium (SPE) payoffs of this repeated principal-agent game. The following code specifies the repeated game
```{r}
library(RelationalContracts)

g = rel_game("Repeated Principal-Agent Game") %>%
  rel_state("x0",
    # Agent's (player 2) action space
    # Discrete effort levels between 0 and 1 
    A2 = list(e=seq(0,1,by=0.01)),
    # Principal (player 1) has no actions 
    # beyond transfers
    A1 = NULL,
    
    # Stage game payoffs
    pi1 = ~ e, # Principal
    pi2 = ~ -(1/2)*e^2 # Agent
  )
```
Note that we always specfiy action sets and payoffs for a particular state. While a repeated game has just a single state, which we have called "x0", our later examples will involve dynamic games with multiple states.

The following code finds all subgame perfect equilibrium (SPE) payoffs of our repeated game given a discount factor of $\delta=0.2$ and shows this payoff set:
```{r fig.width=5, fig.height=5}
g = rel_spe(g,delta=0.2)
plot.spe.payoff.set(g)
```

The SPE payoff set is computed using the algorithms described in our articles Goldluecke and Kranz (2012, 2018). Under our assumption of risk-neutrality and the possibility of monetary transfers, the SPE payoff set always has this special triangular form (a simplex) in which the Pareto-frontier has a slope of -1.

Not only are there many possible equilibrium payoffs but most payoffs can be implemented with many different equilibria (i.e. different strategy profiles). Yet, as described in our articles, it sufficies to find a particular *optimal simple strategy profile* to find the whole SPE payoff set. The following code gives a summary of this strategy profile:

```{r}
get.spe(g,action.details = TRUE) %>%
  select("ae.e", "a1.e","U","v1","v2")
```
Let us first understand Pareto-optimal subgame perfect equilibria. On the equilibrium path, the agent will always choose the effort level `ae.e=0.39`. This is the highest incentive compatible effort level given the earlier specified discount factor `delta=0.2`. The results don't show the payments that take place on the equilibrium path. But it follows from the theoretical results that in this game it is easiest (i.e. possible for the largest range of discount factors) to implement a desired effort level if the principal reimburses the agent his cost of the equilbrium effort. You can think of this payment as a bonus payment for the effort. The crucial assumption for why relational contracting is needed is that such a bonus payment cannot be enforced by formal contracts, since the actual effort choice by the agent is not verifiable by a legal court.

If no other payments were conducted, the corresponding equilibrium payoff would be the lower right point of the equilibrium payoff set. The principal would get the whole surplus `U=ae.e - 0.5*ae.e^2=0.31` and the agent a payoff of 0.

To grant the agent some surplus, one can use incentive compatible upfront payments that the principal transfers to the agent at the beginning of the very first period. One could equivalently think of those upfront payments as a formal contract between principal and agent that grants the agent a fixed wage in addition to the bonus each period. The fixed wage is independent of which effort level is chosen. By modifying this fixed wage, every point on the Pareto-frontier of the Payoff set can be reached. For example, a fixed wage of `0.5*U = 0.157` would split the surplus equally.

If the principal deviates from a required payment, she will be punished by the agent. In our example, one could effectively punish by repeating the stage game Nash equilibrium in which the agent chooses zero effort, `a1.e=0` and no payments are made in all future periods, a so called Nash-reversion grim-trigger punishment. We call `a1.e` the principal's punishment profile. Both principal and agent would then get continuation payoffs of `v1=v2=0`.

Alternatively, the agent could choose zero effort for just one period and one could then give the principal the option to stop the punishment by paying a fine to the agent that must be at least as high as neccessary to make the original deviation not worthwhile. Using such a scheme with fines always allows to implement the harshest possible punishment, which in some games can even be strictly harsher than Nash-reversion grim-trigger. Furthermore such punishments with fines are renegotiation-proof according to Levin's (2003) concept of strong optimality.

The stage game Nash equilibrium that the agent always chooses zero effort and no payments are made is a subgame perfect equilibrium in which both parties get a payoff of 0. This corresponds to the lower-left point on the equilibrium payoff set. One can reach any point below the Pareto-frontier, e.g. by using a public correlation device to mix between a Pareto-efficient equilibrium and this worst equilibrium. Of course, Pareto-dominated equilibrium payoffs can be implemented with many other equilibria, e.g. equilibria that just prescribe lower effort levels on the equilibrium path.

## Effect of Vulnerability 

One can use game theoretic models to study which institutions and formal contracts allow relational contracting to achieve better outcomes. To compare the outcomes under different institutions, it is typically assumed in the relational contracting literature that a relational contract corresponds to a Pareto-optimal subgame perfect equilibrium. The idea is that similar to formal contracts, also informal contracts can be derived by negotiation and coordination between players at the beginning of their relationship. An informal contract just has to obey the incentive compatibilty constraints imposed by a subgame perfect equilibrium. If players can coordinate their behavior, it seems on first sight a quite sensible approximation, that players don't leave money on the table and coordinate to pick a Pareto-optimal SPE as relational contract.  


```{r}
vul_payoff = -1
g = rel_game("Principal-Agent Game") %>%
  rel_param(vul_payoff=-1) %>%
  rel_state("x0",
    A2 = list(e=seq(0,1,by=0.01)),
    pi1 = ~ e,
    pi2 = ~ -(1/2)*e^2
  ) %>%
  # State in which the principal is vulnerable
  rel_state("xVul",
    A2 = list(e=c(vul_payoff,seq(0,1,by=0.01))),
    pi1 = ~ e,
    pi2 = ~ -(1/2)*pmax(0,e)^2
  ) %>%
  # Solve set of SPE payoffs
  rel_spe(delta=0.2)

get.spe(g,action.details = TRUE) %>%
  select(x,U,v1,v2,ae.e,a1.e,a2.e)

plot.spe.payoff.set(g,x=c("xVul","x0"))

```

# Slowly Intensifying Relationships
